var resultLink,fingerFrame,lastInitOp,nameOfDOM,inputDOM,domMsgString,serial,verifyFlag,verifyMsg,appuser,amount,custno,fingerData,operationType,cust_type,deviceId,name,vSessionId,vLogId,vAppUser,fpHTTSrvOpEP="http://127.0.0.1:15170/fpoperation";function takeFingerData(e){document.getElementById("FPImage1").style.backgroundColor="#FFFF99",makeStatusMSgHidden("status_alert"),captureFP()}function captureFP(){}function doProcessing(e,t,n,r,a){document.getElementById(t).value=r,makeStatusMSgVisible("status_alert",n+" is successfully captured . Quality is "+a),changeClassOfDomElement("status_alert","success_alert","danger_alert")}function changeClassOfDomElement(e,t,n){document.getElementById(e).classList.remove(t),document.getElementById(e).classList.remove(n),document.getElementById(e).classList.add(t)}function makeStatusMSgVisible(e,t){var n=document.getElementById(e);n.innerHTML=t,n.style.visibility="visible"}function insertStatus(e,t,n){var r=document.getElementById(e);r.innerHTML=t,r.style="color:"+n+"; padding: 5px; text-align: center;",r.style.visibility="visible"}function makeStatusMSgHidden(e){document.getElementById(e).style.visibility="hidden"}function processData(e){var t=vAppUser,n=apex.item("P101_CUST_NO").getValue(),r=e,a=apex.item("P101_CUST_NO").getValue(),s=vSessionId,o=vLogId,i=JSON.stringify({amount:"0",name:a,appuser:t,custno:n,temp:r,pOperationType:operationType,pLogId:o,pSessionId:s,cust_type:"SAG",pDeviceId:"01000410"}),u=apex.item("P101_FINGER_SERVER_URL").getValue(),l=apex.util.showSpinner();apex.server.process("Verification",{x01:i,x02:u},{success:function(e){!0===e.success?(apex.message.showPageSuccess("Finger Print Matched."),closeModal("P1_NOTIFICATIONS")):(apex.message.clearErrors(),apex.message.showErrors([{type:"error",location:"page",message:"Finger Print Not Matched",unsafe:!1}]))}}),l.remove()}function fixError(e,t){textResult.style="color:blue",changeClassOfDomElement("status_alert","danger_alert"),textResult.innerHTML=""!=t?""!=e?t+"("+e+")":t:e}function setAskTest(e){textResult.style="color:blue",textResult.innerHTML=e}function setOperationResult(e){textResult.style="color:blue",textResult.innerHTML=e}function beginOperation(e,t,n,r,a,s,o,i,u){inputDOM=e,domMsgString=t,vAppUser=s,vLogId=o,vSessionId=i,operationType=u;var l=JSON.stringify({operation:n,username:"",usedlib:r,isoconv:"1",samplenum:"1"});changeClassOfDomElement("status_alert","success_alert");var p=new XMLHttpRequest;p.open("POST",fpHTTSrvOpEP),p.setRequestHeader("Content-type","application/json; charset=utf-8"),p.onload=function(){200==p.status?parseOperationDsc(JSON.parse(p.response)):fixError(p.statusText,"Server response")},p.onerror=function(){changeClassOfDomElement("status_alert","danger_alert"),makeStatusMSgVisible("status_alert","Yu have to install futronic sdk")},p.send(l)}function cancelOperation(){put(fpHTTSrvOpEP+"/"+lastInitOp+"/cancel")}function getOperationState(e){var t=fpHTTSrvOpEP+"/"+e,n=new XMLHttpRequest;n.open("GET",t),n.onload=function(){200==n.status?4==n.readyState&&parseOperationDsc(JSON.parse(n.response)):fixError(n.statusText,"Server response")},n.onerror=function(){fixError("","You have to install Futronic SDK")},n.send()}function getOperationImg(e,t,n){var r=fpHTTSrvOpEP+"/"+e+"/image",a=new XMLHttpRequest;a.open("GET",r),a.responseType="arraybuffer",a.onload=function(){200==a.status?drawFingerFrame(new Uint8Array(a.response),e,t,n):(changeClassOfDomElement("status_alert","danger_alert"),makeStatusMSgVisible("status_alert","fingerprint image is not got"))},a.onerror=function(){enableControlsForOp(!1)},a.send()}function arrayBufferToBase64(e){for(var t="",n=e,r=n.byteLength,a=0;a<r;a++)t+=String.fromCharCode(n[a]);return window.btoa(t)}function getOperationTemplate(e){try{var t=e,n=new XMLHttpRequest;n.open("GET",t),n.responseType="arraybuffer",n.onload=function(){if(200==n.status){var e=new Uint8Array(n.response);if(e[28]<60)alert("Finger quality is poor. Quality : "+e[28]);else processData(arrayBufferToBase64(e))}else changeClassOfDomElement("status_alert","danger_alert"),makeStatusMSgVisible("status_alert","fingerprint template is not got by the system")},n.onerror=function(){changeClassOfDomElement("status_alert","danger_alert"),makeStatusMSgVisible("status_alert","fingerprint template is not got by the system")},n.send()}catch(e){alert(e.message)}}function linkOperationTemplate(e,t){getOperationTemplate(fpHTTSrvOpEP+"/"+e+"/template")}function deleteOperation(e){deleteVerb(fpHTTSrvOpEP+"/"+e)}function parseOperationDsc(e){var t=!0;if("done"==e.state)enableControlsForOp(!1),"success"==e.status&&linkOperationTemplate(e.id,e.operation),"fail"==e.status&&(fixError("",e.errorstr),t=!1,-1!=parseInt(e.errornum)&&deleteOperation(e.id));else if("init"==e.state){lastInitOp=e.id;try{deviceSN=e.sn,serial=deviceSN}catch(e){serial=""}setTimeout(getOperationState,1e3,e.id),setTimeout(getOperationImg,1e3,e.id,parseInt(e.devwidth),parseInt(e.devheight))}else"inprogress"==e.state&&(e.fingercmd,"takeoff"==e.fingercmd&&setAskTest("Take off finger from scanner"),setTimeout(getOperationState,1e3,e.id),setTimeout(getOperationImg,1e3,e.id,parseInt(e.devwidth),parseInt(e.devheight)));return t}function drawFingerFrame(e,t,n,r){var a=fingerFrame.getContext("2d"),s=document.createElement("canvas");s.width=n,s.height=r;for(var o=s.getContext("2d"),i=o.createImageData(n,r),u=0;u<e.length;u++)i.data[4*u]=e[u],i.data[4*u+1]=e[u],i.data[4*u+2]=e[u],i.data[4*u+3]=255;o.putImageData(i,0,0,0,0,n,r),a.drawImage(s,0,0,n,r,0,0,fingerFrame.width,fingerFrame.height)}function deleteVerb(e){var t=new XMLHttpRequest;t.open("DELETE",e),t.onload=function(){200==t.status||fixError(t.statusText,"Server response")},t.onerror=function(){fixError("","You have to install futronic sdk")},t.send()}function put(e){var t=new XMLHttpRequest;t.open("PUT",e),t.onload=function(){200!=t.status&&fixError(t.statusText,"Server response")},t.onerror=function(){fixError("","FPHttpServer not available")},t.send()}function enableControls(){}function enableControlsForOp(e){}function CheckFPHttpSrvConnection(){var e=new XMLHttpRequest;e.open("GET",fpHTTSrvOpEP),e.onload=function(){200==e.status?enableControls():fixError(e.statusText,"Server response")},e.onerror=function(){fixError("","You have to install Futronic sdk."),setTimeout(CheckFPHttpSrvConnection,1e3)},e.send()}function onBodyLoad(){textResult=document.getElementById("status_alert"),fingerFrame=document.getElementById("fingerframe"),resultLink=document.getElementById("resultLink");var e=new Image;e.onload=function(){fingerFrame.getContext("2d").drawImage(e,0,0)},CheckFPHttpSrvConnection()}function refresh(){setTimeout(function(){location.reload()})}