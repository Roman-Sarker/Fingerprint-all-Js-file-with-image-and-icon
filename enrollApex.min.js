var resultLink,fingerFrame,lastInitOp,nameOfDOM,inputDOM,domMsgString,insertFlag,insertMsg,name,app_user,ai_logid,cust_type,onlineChkStatus,data,fpHTTSrvOpEP="http://127.0.0.1:15170/fpoperation",serial="01000410",LThumbValue="",LIndexValue="",RThumbValue="",RIndexValue="",LMiddleValue="",LRingValue="",LLittleValue="",RMiddleValue="",RRingValue="",RLittleValue="";function takeFingerData(e){document.getElementById("FPImage1").style.backgroundColor="#FFFF99",makeStatusMSgHidden("status_alert"),captureFP()}function captureFP(){}function showModal(){$("#myModal").modal("exampleModalCenter"),makeStatusMSgHidden("status_alert")}function doProcessing(e,t,a,n,s){document.getElementById(t).value=n,makeStatusMSgVisible("status_alert",a+" is successfully captured . Quality is "+s),changeClassOfDomElement("status_alert","success_alert","danger_alert")}function changeClassOfDomElement(e,t,a){document.getElementById(e).classList.remove(t),document.getElementById(e).classList.remove(a),document.getElementById(e).classList.add(t)}function makeStatusMSgVisible(e,t){var a=document.getElementById(e);a.innerHTML=t,a.style.visibility="visible"}function insertStatus(e,t,a){var n=document.getElementById(e);n.innerHTML=t,n.style="color:"+a+"; padding: 5px; text-align: center;",n.style.visibility="visible"}function makeStatusMSgHidden(e){document.getElementById(e).style.visibility="hidden"}function processData(e,t,a,n){if(null==LThumbValue||""==LThumbValue)changeClassOfDomElement("status_alert","danger_alert","success_alert"),makeStatusMSgVisible("status_alert","Please provide left thumb finger");else if(null==LIndexValue||""==LIndexValue)changeClassOfDomElement("status_alert","danger_alert","success_alert"),makeStatusMSgVisible("status_alert","Please provide left index finger");else if(null==RThumbValue||""==RThumbValue)changeClassOfDomElement("status_alert","danger_alert","success_alert"),makeStatusMSgVisible("status_alert","Please provide right thumb finger");else if(null==RIndexValue||""==RIndexValue)changeClassOfDomElement("status_alert","danger_alert","success_alert"),makeStatusMSgVisible("status_alert","Please provide right index finger");else if(null==n||""==n)changeClassOfDomElement("status_alert","danger_alert","success_alert"),makeStatusMSgVisible("status_alert","Customer no not found.");else{name=apex.item("P48_CUST_NO").getValue(),app_user=e,ai_logid=t,onlineChkStatus=a,data=JSON.stringify({name:name,app_user:app_user,ai_logid:ai_logid,cust_type:onlineChkStatus,serial:"01000410",lmiddle:LMiddleValue,lring:LRingValue,lthumb:LThumbValue,lindex:LIndexValue,llittle:LLittleValue,rthumb:RThumbValue,rindex:RIndexValue,rmiddle:RMiddleValue,rring:RRingValue,rlittle:RLittleValue});var s=apex.item("P48_PATH").getValue(),r=apex.util.showSpinner();apex.server.process("Enrollment",{x01:data,x02:s},{success:function(e){!0===e.success?(apex.navigation.dialog.close(!0,["P48_CUST_NO"]),apex.message.showPageSuccess("Finger Print Enroll Successfully. Test"),apex.message.showPageSuccess(e.message)):(apex.message.clearErrors(),apex.message.showErrors([{type:"error",location:"page",message:e.message,unsafe:!1}]))}}),r.remove()}}function fixError(e,t){textResult.style="color:blue",changeClassOfDomElement("status_alert","danger_alert"),textResult.innerHTML=""!=t?""!=e?t+"("+e+")":t:e}function setAskTest(e){textResult.style="color:blue",textResult.innerHTML=e}function setOperationResult(e){textResult.style="color:blue",textResult.innerHTML=e}function beginOperation(e,t,a,n,s){inputDOM=e,domMsgString=t;var r=JSON.stringify({operation:a,username:"",usedlib:n,isoconv:"1",samplenum:"1"});changeClassOfDomElement("status_alert","success_alert");var i=new XMLHttpRequest;i.open("POST",fpHTTSrvOpEP),i.setRequestHeader("Content-type","application/json; charset=utf-8"),i.onload=function(){200==i.status?(setAskTest("Operation begin"),parseOperationDsc(JSON.parse(i.response))):fixError(i.statusText,"Server response")},i.onerror=function(){changeClassOfDomElement("status_alert","danger_alert"),makeStatusMSgVisible("status_alert","You have to install futronic sdk")},i.send(r)}function cancelOperation(){put(fpHTTSrvOpEP+"/"+lastInitOp+"/cancel")}function getOperationState(e){var t=fpHTTSrvOpEP+"/"+e,a=new XMLHttpRequest;a.open("GET",t),a.onload=function(){200==a.status?4==a.readyState&&parseOperationDsc(JSON.parse(a.response)):fixError(a.statusText,"Server response")},a.onerror=function(){fixError("","You have to install Futronic SDK")},a.send()}function getOperationImg(e,t,a){var n=fpHTTSrvOpEP+"/"+e+"/image",s=new XMLHttpRequest;s.open("GET",n),s.responseType="arraybuffer",s.onload=function(){200==s.status?drawFingerFrame(new Uint8Array(s.response),e,t,a):(changeClassOfDomElement("status_alert","danger_alert"),makeStatusMSgVisible("status_alert","fingerprint image is not got"))},s.onerror=function(){enableControlsForOp(!1)},s.send()}function arrayBufferToBase64(e){for(var t="",a=e,n=a.byteLength,s=0;s<n;s++)t+=String.fromCharCode(a[s]);return window.btoa(t)}function getOperationTemplate(e){try{var t=e,a=new XMLHttpRequest;a.open("GET",t),a.responseType="arraybuffer",a.onload=function(){if(200==a.status){var e=new Uint8Array(a.response);if(e[26]<60)alert("Finger quality is poor. Quality : "+e[26]);else{var t=arrayBufferToBase64(e);"LThumb"==inputDOM&&(LThumbValue=t),"LIndex"==inputDOM&&(LIndexValue=t),"LMiddle"==inputDOM&&(LMiddleValue=t),"LRing"==inputDOM&&(LRingValue=t),"LLittle"==inputDOM&&(LLittleValue=t),"RThumb"==inputDOM&&(RThumbValue=t),"RIndex"==inputDOM&&(RIndexValue=t),"RMiddle"==inputDOM&&(RMiddleValue=t),"RRing"==inputDOM&&(RRingValue=t),"RLittle"==inputDOM&&(RLittleValue=t),changeClassOfDomElement("status_alert","success_alert"),makeStatusMSgVisible("status_alert",domMsgString+" is successfully captured. Standard "+e[26]);var n=1;document.getElementById("x").value=n,(n=1)&&(document.getElementById(inputDOM).style.backgroundImage="url('/i/emob/Finger/right1.png')")}}else changeClassOfDomElement("status_alert","danger_alert"),makeStatusMSgVisible("status_alert","fingerprint template is not got by the system")},a.onerror=function(){changeClassOfDomElement("status_alert","danger_alert"),makeStatusMSgVisible("status_alert","fingerprint template is not got by the system")},a.send()}catch(e){alert(e.message)}}function linkOperationTemplate(e,t){getOperationTemplate(fpHTTSrvOpEP+"/"+e+"/template")}function deleteOperation(e){deleteVerb(fpHTTSrvOpEP+"/"+e)}function parseOperationDsc(e){var t=!0;if("done"==e.state)enableControlsForOp(!1),"success"==e.status&&(setOperationResult(e.message),linkOperationTemplate(e.id,e.operation)),"fail"==e.status&&(fixError("",e.errorstr),t=!1,-1!=parseInt(e.errornum)&&deleteOperation(e.id));else if("init"==e.state){lastInitOp=e.id;try{deviceSN=e.sn,serial=deviceSN}catch(e){serial=""}setTimeout(getOperationState,1e3,e.id),setTimeout(getOperationImg,1e3,e.id,parseInt(e.devwidth),parseInt(e.devheight))}else"inprogress"==e.state&&("puton"==e.fingercmd&&setAskTest("Put finger on scanner"),"takeoff"==e.fingercmd&&setAskTest("Take off finger from scanner"),setTimeout(getOperationState,1e3,e.id),setTimeout(getOperationImg,1e3,e.id,parseInt(e.devwidth),parseInt(e.devheight)));return t}function drawFingerFrame(e,t,a,n){var s=fingerFrame.getContext("2d"),r=document.createElement("canvas");r.width=a,r.height=n;for(var i=r.getContext("2d"),l=i.createImageData(a,n),o=0;o<e.length;o++)l.data[4*o]=e[o],l.data[4*o+1]=e[o],l.data[4*o+2]=e[o],l.data[4*o+3]=255;i.putImageData(l,0,0,0,0,a,n),s.drawImage(r,0,0,a,n,0,0,fingerFrame.width,fingerFrame.height)}function deleteVerb(e){var t=new XMLHttpRequest;t.open("DELETE",e),t.onload=function(){200==t.status||fixError(t.statusText,"Server response")},t.onerror=function(){fixError("","You have to install futronic sdk")},t.send()}function put(e){var t=new XMLHttpRequest;t.open("PUT",e),t.onload=function(){200!=t.status&&fixError(t.statusText,"Server response")},t.onerror=function(){fixError("","FPHttpServer not available")},t.send()}function enableControls(){}function enableControlsForOp(e){}function CheckFPHttpSrvConnection(){var e=new XMLHttpRequest;e.open("GET",fpHTTSrvOpEP),e.onload=function(){200==e.status?(enableControls(),setAskTest("Press on finger")):fixError(e.statusText,"Server response")},e.onerror=function(){fixError("","You have to install Futronic sdk."),setTimeout(CheckFPHttpSrvConnection,1e3)},e.send()}function onBodyLoad(){textResult=document.getElementById("status_alert"),fingerFrame=document.getElementById("fingerframe"),resultLink=document.getElementById("resultLink");var e=new Image;e.onload=function(){fingerFrame.getContext("2d").drawImage(e,0,0)},CheckFPHttpSrvConnection()}function refresh(){setTimeout(function(){location.reload()})}